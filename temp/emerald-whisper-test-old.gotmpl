{{/* ============================================== */}}
{{/* Region role IDs → region chat channels */}}
{{$regionChannels := dict
 "1455368706610827426" "1448540341878657024"
 "1455368838953832530" "1448540757123399791"
 "1455368920159621343" "1448551404724817920"
 "1455368992502972507" "1448551487939678371"
 "1455369088284233789" "1455368546208055408"
 "1455367689915863120" "1455367633263264020"

}}
{{/* Spectator log channel ID */}}
{{$spectatorChannel := 1449146565271748850}}
{{/* Whisper limit per user */}}
{{$whisperLimit := 3}}
{{/* Shorthand name → User ID mapping */}}
{{/* ADMINS */}}
{{$playerIDs := dict
 "reece" 391415444084490240
 "belle" 676262975132139522
 "bec" 703974323098222603
 "adrian" 224237085450698752
 "smiles" 434543059494109185
 "stripe" 84040775406518276
 "dino" 1086246253819613274
 "beavis" 242017916826943489
 "butthead" 883720052224954368
 "leech" 794991430257868810
 "william" 579449386812047366
 "claus" 478386446835646483
 "tea" 607045822374215682
 "nicko" 279758197009547274
 "vic" 649346742000680991
 "alex" 202627838451384320
 "typo" 149555318370598915
 "sarah" 209773824357564416
 "paige" 1388959151857602731
 "esme" 745788374165749889
 "ryann" 683102296380276766
 "danny" 179379717202378752
 "morgane" 977455730300956683
 "garrett" 199671652223680522
 "zach" 224371680825442304
 "sara" 630235663026880512
 "astra" 563213866369024001
 "catpaige" 430900105256763403
 "pelicanzach" 351178582132785173
 "jason" 691850627189309492
 "shawn" 1220822709013844020
}}
{{/* USER ID → private channel mapping */}}
{{/* ADMINS */}}
{{$userChannels := dict
 391415444084490240 1455368876928925947
 676262975132139522 1455368906800759058
 703974323098222603 1455368906800759058
 224237085450698752 1455368906800759058
 434543059494109185 1455368876928925947
 84040775406518276 1455368906800759058
 1086246253819613274 1455368906800759058
 242017916826943489 1455379845147005089
 883720052224954368 1455379873865531565
 794991430257868810 1455379896443469904
 579449386812047366 1455379921882058763
 478386446835646483 1455379955470045194
 607045822374215682 1455379981088850034
 279758197009547274 1455380042619289610
 649346742000680991 1455380064135807056
 202627838451384320 1455380086428537052
 149555318370598915 1455380118880129150
 209773824357564416 1455380149972504616
 1388959151857602731 1455380333460459520
 745788374165749889 1455380363043147888
 683102296380276766 1455380395284500611
 179379717202378752 1455380420118974484
 977455730300956683 1455380451030990982
 199671652223680522 1455380472724066516
 224371680825442304 1455380497013145620
 630235663026880512 1455380520564293770
 563213866369024001 1455380547231678506
 430900105256763403 1455380575472058563
 351178582132785173 1455380603900919869
 691850627189309492 1455380785732518009
 1220822709013844020 1455380810503815218
}}
{{/* ============================================== */}}
{{/* Parse arguments */}}
{{$args := parseArgs 2 "Usage: `!whisper targetName message`"
 (carg "string" "Target player shorthand name")
 (carg "string" "Message")
}}
{{$targetName := lower ($args.Get 0)}}
{{$msg := $args.Get 1}}
{{/* ============================================== */}}
{{/* Look up target by name */}}
{{$targetID := index $playerIDs $targetName}}
{{if not $targetID}}
 {{$valid := cslice}}
 {{range $k, $_ := $playerIDs}} {{$valid = $valid.Append $k}} {{end}}
 {{sendMessage nil (print " Unknown player `" $targetName "`. Valid names: " (joinStr ", " $valid))}}
 {{return}}
{{end}}
{{$targetMember := getMember $targetID}}
{{if not $targetMember}}
 {{sendMessage nil " Could not find that player."}}
 {{return}}
{{end}}
{{/* ============================================== */}}
{{/* Determine shared region role */}}
{{$sharedRegion := ""}}
{{range .Member.Roles}}
 {{$roleID := .}}
 {{if in $targetMember.Roles $roleID}}
 {{if index $regionChannels (str $roleID)}}
 {{$sharedRegion = (str $roleID)}}
 {{end}}
 {{end}}
{{end}}
{{if eq $sharedRegion ""}}
 {{sendMessage nil (print " You and " $targetName " are not in the same area. You can only whisper to players in your area.")}}
 {{return}}
{{end}}
{{/* ============================================== */}}
{{/* Get target private channel */}}
{{$targetChannel := index $userChannels $targetID}}
{{if not $targetChannel}}
 {{sendMessage nil " Error."}}
 {{return}}
{{end}}
{{/* ============================================== */}}
{{/* Get sender shorthand name */}}
{{$senderID := .User.ID}}
{{$senderName := ""}}
{{range $name, $id := $playerIDs}}
 {{if eq $id $senderID}}
 {{$senderName = $name}}
 {{end}}
{{end}}
{{if eq $senderName ""}}
 {{$senderName = "Unknown"}}
{{end}}
{{/* ============================================== */}}
{{/* Whisper count using a single DB object */}}
{{$dbKey := "whisper_counts"}}
{{$counts := sdict}}
{{$entry := dbGet .Guild.ID $dbKey}}
{{if $entry}}
 {{$counts = sdict $entry.Value}}
{{end}}

{{$userCount := 0}}
{{with index $counts (str $senderID)}}
 {{$userCount = .}}
{{end}}

{{if ge $userCount $whisperLimit}}
 {{sendMessage nil (print "❌ You've reached your whisper limit (" $whisperLimit "). Wait for a reset.")}}
 {{return}}
{{end}}
{{/* ============================================== */}}
{{/* Capitalize names */}}
{{$targetDisplay := print (upper (slice $targetName 0 1)) (lower (slice $targetName 1))}}
{{$senderDisplay := print (upper (slice $senderName 0 1)) (lower (slice $senderName 1))}}
{{/* ============================================== */}}
{{/* Send whisper to target private channel */}}
{{sendMessage $targetChannel (print "**Whisper from " $senderDisplay "**\n>>> " $msg)}}
{{/* Announce to region chat */}}
{{$announceChannel := index $regionChannels $sharedRegion}}
{{if $announceChannel}}
 {{sendMessage $announceChannel (print "**" $senderDisplay "** whispered to **" $targetDisplay "**.")}}
{{end}}
{{/* ============================================== */}}
{{/* NEW: Get the readable region name for spectators */}}
{{$locationName := "Unknown Location"}}
{{with (getRole $sharedRegion)}}
 {{$locationName = .Name}}
{{end}}
{{/* ============================================== */}}
{{/* Send full whisper content to Spectator channel */}}
{{if $spectatorChannel}}
 {{sendMessage $spectatorChannel (print
 "**" $senderDisplay "** → **"
 $targetDisplay "** "
 "(" $locationName ")\n"
 ">>> " $msg
 )}}
{{end}}
{{/* Confirm to sender */}}
{{sendMessage nil (print "✅ Whisper sent to " $targetDisplay ". " (sub $whisperLimit (add $userCount 1)) " whispers remaining.")}}

{{/* Increment count after successful whisper */}}
{{$counts.Set (str $senderID) (add $userCount 1)}}
{{dbSet .Guild.ID $dbKey $counts}} 